---
title: "📝 Práctica 3"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#101010"
      fg: "#FDF7F7" 
      primary: "#5C8374"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
if (!require("flexdashboard")) install.packages("flexdashboard")
if (!require("DT")) install.packages("DT")
library(tidyverse)
library(dplyr)
library(flexdashboard)
library(DT)
library(highcharter)
load("_data/datos_completos.RData")
```
⚙️ 1: Preparación de los datos
=======================================================================
Procesamos los CSV en otro archivo y aqui solo leemos los dataframe

Column {data-width=650 .tabset}
-----------------------------------------------------------------------
### 📊 Datos completos

```{r}
datatable(df_datos_completos)
```

### 🧑‍🤝‍🧑 Clientes

```{r}
datatable(df_clientes)
```

### 🛠️  Servicios

```{r}
datatable(df_servicios)
```

### 💰️ Tramsacciones

```{r}
datatable(df_transacciones)
```
### 📢️ Campañas

```{r}
datatable(df_campanias)
```

Column {data-width=350}
-----------------------------------------------------------------------
ℹ️ Definición

### STR

```{r}
str(df_datos_completos)
```

### 📈 Summary

```{r}
summary(df_datos_completos)
```
📊 2: Visualizaciones interactivas
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------

### ✅ 1. Ventas por Categoría de Servicio

```{r}
df_datos_completos %>%
  group_by(categoría) %>%
  summarise(ventas_totales = sum(total, na.rm = TRUE)) %>%
  hchart("column", hcaes(x = categoría, y = ventas_totales)) %>%
  hc_title(text = "Ventas por Categoría de Servicio") %>%
  hc_xAxis(title = list(text = "Categoría")) %>%
  hc_yAxis(title = list(text = "Total en Bs"))
```
### 📊 2. Distribución de Clientes por Edad
```{r}
hchart(
  hist(df_datos_completos$edad, breaks = seq(0, 100, by = 5), plot = FALSE),
  color = "#3182bd"
) %>%
  hc_title(text = "Distribución de Edad de Clientes") %>%
  hc_xAxis(title = list(text = "Edad")) %>%
  hc_yAxis(title = list(text = "Frecuencia"))

```
### 📍 3. Ventas por Departamento
```{r}
df_datos_completos %>%
  group_by(departamento) %>%
  summarise(ventas_totales = sum(total, na.rm = TRUE)) %>%
  arrange(desc(ventas_totales)) %>%  # Ordena de mayor a menor
  hchart("bar", hcaes(x = departamento, y = ventas_totales, color = ventas_totales)) %>%
  hc_title(text = "Ventas por Departamento") %>%
  hc_xAxis(title = list(text = "Departamento")) %>%
  hc_yAxis(title = list(text = "Total en Bs")) %>%
  hc_colors(c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2")) %>%
  hc_legend(enabled = TRUE, title = list(text = "Departamentos"))
```

### 🚻 4. Ventas por Género
```{r}
df_datos_completos %>%
  group_by(genero) %>%
  summarise(ventas_totales = sum(total, na.rm = TRUE)) %>%
  hchart("pie", hcaes(x = genero, y = ventas_totales), 
         color = c("#1f77b4", "#ff7f0e", "#2ca02c")) %>%
  hc_title(text = "Ventas por Género") %>%
  hc_tooltip(pointFormat = "{series.name}: <b>{point.percentage:.1f}%</b>")
```

### 🌆 5. Participación por Ciudad
```{r}
df_datos_completos %>%
  count(ciudad, name = "total_clientes") %>%
  hchart("bar", hcaes(x = ciudad, y = total_clientes)) %>%
  hc_title(text = "Participación por Ciudad") %>%
  hc_xAxis(title = list(text = "Ciudad")) %>%
  hc_yAxis(title = list(text = "Cantidad de Clientes"))
```

### 📈 6. Tendencias de Ventas por Fecha

```{r}
df_datos_completos %>%
  mutate(fecha = ymd(fecha)) %>%
  group_by(fecha) %>%
  summarise(ventas_totales = sum(total)) %>%
  hchart("line", hcaes(x = fecha, y = ventas_totales)) %>%
  hc_title(text = "Tendencia de Ventas por Fecha") %>%
  hc_xAxis(type = "datetime", title = list(text = "Fecha")) %>%
  hc_yAxis(title = list(text = "Total en Bs"))

```

### 📊 7. Histograma de Frecuencia de Ventas

```{r}
hchart(
  hist(df_datos_completos$total, plot = FALSE),
  color = "#a1d99b"
) %>%
  hc_title(text = "Histograma de Frecuencia de Ventas") %>%
  hc_xAxis(title = list(text = "Monto Total (Bs)")) %>%
  hc_yAxis(title = list(text = "Frecuencia"))

```

### 🟠 8. Dispersión entre Edad y Monto de Venta

```{r}
hchart(df_datos_completos, "scatter", hcaes(x = edad, y = total)) %>%
  hc_title(text = "Dispersión entre Edad y Monto de Venta") %>%
  hc_xAxis(title = list(text = "Edad del Cliente")) %>%
  hc_yAxis(title = list(text = "Monto de la Transacción (Bs)"))
```

🧭️ 3: Visualización geoespacial con rutas
=======================================================================

Row
-----------------------------------------------------------------------
### Chart 1
```{r}
str(df_campanias)
```

📈 4: KPIs {data-orientation=rows}
=======================================================================

Row
-----------------------------------------------------------------------
```{r setup1, include=FALSE}

# Total de ingresos generados
total_ingresos <- sum(df_datos_completos$total, na.rm = TRUE)

# Total de clientes únicos
total_clientes <- n_distinct(df_datos_completos$id_cliente)

# Total de transacciones
total_transacciones <- nrow(df_datos_completos)

# Servicio más solicitado
servicio_top <- df_datos_completos %>%
  count(nombre_servicio, sort = TRUE) %>%
  slice(1) %>%
  pull(nombre_servicio)

# Departamento con más ventas
departamento_top <- df_datos_completos %>%
  group_by(departamento) %>%
  summarise(ventas = sum(total, na.rm = TRUE)) %>%
  arrange(desc(ventas)) %>%
  slice(1) %>%
  pull(departamento)

```

### Total de ingresos
```{r}
valueBox(formatC(total_ingresos, format = "f", big.mark = ",", digits = 2), "Total de ingresos", icon = "fa-dollar-sign")
```

### Clientes únicos
```{r}
valueBox(total_clientes, "Clientes únicos", icon = "fa-users")
```

Row
-----------------------------------------------------------------------
### Transacciones
```{r}
valueBox(total_transacciones, "Transacciones", icon = "fa-exchange-alt")
```

### Servicio más solicitado
```{r}
valueBox(servicio_top, "Servicio más solicitado", icon = "fa-cogs")
```
### Departamento líder
```{r}
valueBox(departamento_top, "Departamento líder", icon = "fa-map-marked-alt")
```


🎓 5: Créditos
=======================================================================

**📄 Informe de Visualización de Datos**

- 👨‍🎓 **Nombre del Estudiante:** Gaston Nina Sossa  
- 🧑‍💻 **Carrera:** Ingeniería de Sistemas  
- 📊 **Módulo:** Visualización de Datos  
- 🎓 **Universidad:** Universidad Mayor de San Andrés  
- 👨‍🏫 **Docente:** David ..  
- 📅 **Gestión:** 2024 - Segundo Semestre
